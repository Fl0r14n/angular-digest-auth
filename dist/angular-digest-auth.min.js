/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.1.2 - 2014-01-16
 * @link https://github.com/mgonto/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var dgAuth=angular.module("dgAuth",["angular-md5","ngCookies"]);dgAuth.config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","$authConfig",function(a,b,c){return{request:function(d){return a.$broadcast(c.getEvent("process.request"),d),d||b.when(d)},responseError:function(d){if(401===d.status){if(a.$broadcast(c.getEvent("process.response"),d),d.mustTerminate)return b.reject(d);var e=d.headers(c.getHeader());if(null==e)return a.$broadcast(c.getEvent("authentication.notFound")),b.reject(d);var f=b.defer(),g={config:d.config,deferred:f};return a.$broadcast(c.getEvent("authentication.header"),e,g),a.$broadcast(c.getEvent("signin.required")),f.promise}return b.reject(d)}}}])}]),dgAuth.run(["$rootScope","$authConfig","$authService","$clientAuth","$serverAuth",function(a,b,c,d,e){a.$on(b.getEvent("process.request"),function(a,b){if(d.isConfigured()){var e=c.getCredentials();d.processRequest(e.username,e.password,b)}}),a.$on(b.getEvent("process.response"),function(a,b){c.mustTerminate(b)}),a.$on(b.getEvent("authentication.header"),function(a,b,d){c.setHttpRequest(d),e.parseHeader(b)})}]),dgAuth.factory("$clientAuth",["$rootScope","$serverAuth","md5",function(a,b,c){function d(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0,e=function(b){for(var c=[],d=a.length,e=0;b>e;++e)c.push(a[Math.random()*d|0]);return c.join("")},f=function(){d++;for(var a=8-d.toString().length,b="",c=0;a>c;c++)b+="0";return b+d},g=function(a,d,e,f,g,h){var i=c.createHash(a+":"+b.realm+":"+d),j=c.createHash(e+":"+f);return c.createHash(i+":"+b.nonce+":"+g+":"+h+":"+b.qop+":"+j)},h=function(a,c,d,h){var i=f(),j=e(16);return'Digest username="'+a+'", realm="'+b.realm+'", nonce="'+b.nonce+'", uri="'+h+'", algorithm='+b.algorithm+', response="'+g(a,c,d,h,i,j)+'", opaque="'+b.opaque+'", qop='+b.qop+', nc="'+i+'", cnonce="'+j+'"'};this.isConfigured=function(){return b.isConfigured()},this.processRequest=function(a,c,d){d.url.indexOf(b.domain)>=0&&(d.headers.Authorization=h(a,c,d.method,d.url))}}return new d}]),dgAuth.provider("$authConfig",function(){function a(a,b,c){var d=a,e=b,f=c;this.getSign=function(){return d},this.getEvents=function(){return e},this.getEvent=function(a){var b=a.split(".");return e[b[0]][b[1]]},this.getHeader=function(){return f}}var b={signin:"",signout:"",config:{}},c={authentication:{header:"$authAuthenticationHeader"},process:{request:"$authProcessRequest",response:"$authProcessResponse"},signin:{successful:"$authSigninSuccessful",error:"$authSigninError",required:"$authSigninRequired"},signout:{successful:"$authSignoutSuccessful",error:"$authSignoutError"},credential:{submitted:"$authCredentialSubmitted",stored:"$authCredentialStored",restored:"$authCredentialRestored"}},d="";this.setSign=function(a){angular.extend(b,a)},this.setEvents=function(a){angular.extend(c,a)},this.setHeader=function(a){d=a},this.$get=function(){return new a(b,c,d)}}),dgAuth.factory("$serverAuth",["$authStorage",function(a){function b(){var b=/([a-zA-Z]+)=\"?([a-zA-Z0-9\/\s]+)\"?/,c=!1;this.realm="",this.domain="",this.nonce="",this.opaque="",this.algorithm="",this.qop="",this.isConfigured=function(){return c},this.config=function(a){this.realm=a.realm,this.domain=a.domain,this.nonce=a.nonce,this.opaque=a.opaque,this.algorithm=a.algorithm,this.qop=a.qop,c=!0},this.parseHeader=function(d){for(var e=d.split(", "),f=0;f<e.length;f++){var g=b.exec(e[f]);this[g[1]]=g[2]}c=!0,a.setServerAuth(this)}}var c=function(){var c=new b;return a.hasServerAuth()&&c.config(a.getServerAuth()),c};return c()}]),dgAuth.provider("$authService",[function(){function a(a,b,c,d,e,f,g,h){var i=a.signin,j=a.signout,k=a.callbacks,l=a.automatic,m=null,n=function(){return{username:"",password:"",httpRequest:null,deferred:null,mustTerminate:!1}},o=function(){return{deferred:null,mustTerminate:!0}},p=n(),q=o();this.setHttpRequest=function(a){angular.extend(p,{httpRequest:a})},this.hasIdentity=function(){return null!==m},this.getIdentity=function(){return m},this.setCredentials=function(a,c){angular.extend(p,{username:a,password:c,mustTerminate:!0}),d.$broadcast(b.getEvent("credential.submitted"),{username:p.username,password:p.password})},this.getCredentials=function(){return{username:p.username,password:p.password}},this.mustTerminate=function(a){return a.config.url==i.url?(a.mustTerminate=p.mustTerminate,void 0):(a.config.url==j.url&&(a.mustTerminate=q.mustTerminate),void 0)};var r=function(){var a=f.defer();return e(i).success(function(e){m=angular.extend({username:p.username},e),g._auth=h.createHash("true"),c.setCredentials(p.username,p.password),d.$broadcast(b.getEvent("credential.stored"),{username:p.username,password:p.password}),d.$broadcast(b.getEvent("signin.successful"),e),angular.extend(p,{mustTerminate:!1}),a.resolve(e)}).error(function(c,e){d.$broadcast(b.getEvent("signin.error"),c,e),p=n(),a.reject(c)}),a};this.signin=function(){if((g._auth==h.createHash("true")||l)&&c.hasCredential()&&angular.extend(p,{username:c.getUsername(),password:c.getPassword(),mustTerminate:!0}),p.httpRequest){var a=e(p.httpRequest.config).then(function(a){p.httpRequest.deferred.resolve(a)},function(a){p.httpRequest.deferred.reject(a)});a["finally"](function(){p.httpRequest=null})}else p.deferred||(p.deferred=r(),p.deferred.promise.then(k.login.successful,k.login.error));return p.deferred.promise};var s=function(){var a=f.defer();return e(j).success(function(c){g._auth=h.createHash("false"),m=null,p=n(),d.$broadcast(b.getEvent("signout.successful"),c),a.resolve(c)}).error(function(c,e){d.$broadcast(b.getEvent("signout.error"),c,e),a.reject(c)}),a};this.signout=function(){return q.deferred||(q.deferred=s(),q.deferred.promise.then(k.logout.successful,k.logout.error)),q.deferred.promise},this.isAuthenticated=function(){var a=f.defer();return q.deferred?q.deferred.promise.then(function(){a.reject(null)},function(){a.resolve(g._auth==h.createHash("true")&&null!==m)}):p.deferred&&p.deferred.promise.then(function(){a.resolve(g._auth==h.createHash("true")&&null!==m)},function(b){a.reject(b)}),a.promise}}var b=!0;this.setAutomatic=function(a){b=a},this.getAutomatic=function(){return b};var c={method:"POST",url:"/signin"};this.setSignin=function(a){angular.extend(c,a)},this.getSignin=function(){return c};var d={method:"POST",url:"/signout"};this.setSignout=function(a){angular.extend(d,a)},this.getSignout=function(){return d};var e={login:{successful:function(){},error:function(){}},logout:{successful:function(){},error:function(){}}};this.setCallbacks=function(a){angular.extend(e,a)},this.getCallbacks=function(){return e},this.$get=["$authConfig","$authStorage","$rootScope","$http","$q","$cookies","md5",function(f,g,h,i,j,k,l){return new a({signin:c,signout:d,callbacks:e,automatic:b},f,g,h,i,j,k,l)}]}]),dgAuth.provider("$authStorage",function(){function a(a){var b=a;this.hasCredential=function(){var a=b.getItem("username"),c=b.getItem("password");return null!==a&&null!==c},this.setCredentials=function(a,c){b.setItem("username",a),b.setItem("password",c)},this.hasServerAuth=function(){return null!==sessionStorage.getItem("server")},this.setServerAuth=function(a){sessionStorage.setItem("server",JSON.stringify(a))},this.getServerAuth=function(){return JSON.parse(sessionStorage.getItem("server"))},this.getUsername=function(){return b.getItem("username")},this.getPassword=function(){return b.getItem("password")},this.clear=function(){b.clear(),sessionStorage.clear()}}var b=sessionStorage;this.setStorage=function(a){b=a},this.$get=function(){return new a(b)}});