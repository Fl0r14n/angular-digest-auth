/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.1.0 - 2014-01-10
 * @link https://github.com/mgonto/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var dhAuth=angular.module("dhAuth",["angular-md5","ngCookies"]);dhAuth.provider("$authStorage",function(){function a(a){var b=a;this.hasCredential=function(){var a=b.getItem("username"),c=b.getItem("password");return null!==a&&null!==c},this.setCredential=function(a,c){b.setItem("username",a),b.setItem("password",c)},this.hasServerAuth=function(){return null!==sessionStorage.getItem("server")},this.setServerAuth=function(a){sessionStorage.setItem("server",JSON.stringify(a))},this.getServerAuth=function(){return JSON.parse(sessionStorage.getItem("server"))},this.getUsername=function(){return b.getItem("username")},this.getPassword=function(){return b.getItem("password")},this.clear=function(){b.clear()}}var b=sessionStorage;this.setStorage=function(a){b=a},this.$get=function(){return new a(b)}}),dhAuth.factory("$serverAuth",["$authStorage",function(a){function b(){var b=/([a-zA-Z]+)=\"?([a-zA-Z0-9\/\s]+)\"?/,c=!1;this.realm="",this.domain="",this.nonce="",this.opaque="",this.algorithm="",this.qop="",this.hasHeader=function(){return c},this.config=function(a){this.realm=a.realm,this.domain=a.domain,this.nonce=a.nonce,this.opaque=a.opaque,this.algorithm=a.algorithm,this.qop=a.qop,c=!0},this.parseHeader=function(d){for(var e=d.split(", "),f=0;f<e.length;f++){var g=b.exec(e[f]);this[g[1]]=g[2]}c=!0,a.setServerAuth(this)}}var c=function(){var c=new b;return a.hasServerAuth()&&c.config(a.getServerAuth()),c};return c()}]),dhAuth.factory("$clientAuth",["$rootScope","$serverAuth","md5",function(a,b,c){function d(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0,e=function(b){for(var c=[],d=a.length,e=0;b>e;++e)c.push(a[Math.random()*d|0]);return c.join("")},f=function(){d++;for(var a=8-d.toString().length,b="",c=0;a>c;c++)b+="0";return b+d},g=function(a,d,e,f,g,h){var i=c.createHash(a+":"+b.realm+":"+d),j=c.createHash(e+":"+f);return c.createHash(i+":"+b.nonce+":"+g+":"+h+":"+b.qop+":"+j)},h=function(a,c,d,h){var i=f(),j=e(16);return'Digest username="'+a+'", realm="'+b.realm+'", nonce="'+b.nonce+'", uri="'+h+'", algorithm='+b.algorithm+', response="'+g(a,c,d,h,i,j)+'", opaque="'+b.opaque+'", qop='+b.qop+', nc="'+i+'", cnonce="'+j+'"'};this.isConfigured=function(){return b.hasHeader()},this.processRequest=function(a,c,d){d.url.indexOf(b.domain)>=0&&(d.headers.Authorization=h(a,c,d.method,d.url))}}return new d}]),dhAuth.provider("$authConfig",function(){function a(a,b,c){var d=a,e=b,f=c;this.getSign=function(){return d},this.getEvents=function(){return e},this.getHeader=function(){return f}}var b={signin:"",signout:"",config:""},c={authenticationHeader:"$authAuthenticationHeader",loginSuccessful:"$authLoginSuccessful",loginError:"$authLoginError",logoutSuccessful:"$authLogoutSuccessful",logoutError:"$authLogoutError",loginRequired:"$authLoginRequired",loginSubmitted:"$authLoginSubmitted",loginStored:"$authLoginStored"},d="";this.setSign=function(a){angular.extend(b,a)},this.setEvents=function(a){angular.extend(c,a)},this.setHeader=function(a){d=a},this.$get=function(){return new a(b,c,d)}}),dhAuth.factory("$authService",["$authConfig","$authStorage","$clientAuth","$rootScope","$cookies","md5","$log",function(a,b,c,d,e,f,g){function h(){var h={username:"",password:"",logged:!1,requested:!1},i=function(){return e._auth==f.createHash("true")},j=function(c){g.debug("Login successful."),e._auth=f.createHash("true"),h.requested&&b.setCredential(h.username,h.password),d.$broadcast(a.getEvents().loginSuccessful,c)},k=function(b,c){g.debug("Login error."),h=null,d.$broadcast(a.getEvents().loginError,b,c)},l=function(b){e._auth=f.createHash("false"),d.$broadcast(a.getEvents().logoutSuccessful,b)},m=function(){};this.setLoginRequest=function(a,b){h={username:a,password:b,logged:!1,requested:!0}},this.getLoginRequest=function(){return h},this.isLoginRequest=function(){return h.requested},this.isAbleToSignin=function(){return c.isConfigured()&&b.hasCredential()},this.isAuthenticated=function(){return i()},this.processRequest=function(a){if(c.isConfigured()){if(h||b.hasCredential()){var d,e;b.hasCredential()?(d=b.getUsername(),e=b.getPassword()):(d=h.username,e=h.password)}c.processRequest(d,e,a)}},this.signin=function(){d.$broadcast("$authRequestSignin",{successful:j,error:k})},this.signout=function(){d.$broadcast("$authRequestSignout",{successful:l,error:m})}}return new h}]),dhAuth.config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","$authConfig","$authService","$log",function(a,b,c,d,e){return{request:function(a){return d.processRequest(a),a||b.when(a)},responseError:function(f){if(401===f.status){e.debug("Server has requested an authentication.");var g=b.defer(),h={config:f.config,deferred:g},i=c.getEvents();return a.requests401.push(h),a.$broadcast(i.authenticationHeader,f.headers(c.getHeader())),d.isLoginRequest()&&a.$broadcast(i.loginError),d.isAbleToSignin()?a.$broadcast(i.loginStored):a.$broadcast(i.loginRequired),g.promise}return b.reject(f)}}}])}]),dhAuth.run(["$rootScope","$authConfig","$authService","$authStorage","$serverAuth","$http","$log",function(a,b,c,d,e,f,g){a.requests401=[];var h=b.getEvents(),i=function(a,c){g.debug("Performs a sign in."),f.post(b.getSign().signin,b.getSign().config).success(c.successful).error(c.error)},j=function(a,c){g.debug("Performs a sign out."),f.post(b.getSign().signout,b.getSign().config).success(c.logoutSuccessful).error(c.logoutError)},k=function(){g.debug("Request another sign in.");for(var b=0;b<a.requests401.length;b++){var c=a.requests401[b];f(c.config).then(function(a){c.deferred.resolve(a)})}};a.$on("$authRequestSignin",i),a.$on("$authRequestSignout",j),a.$on(h.authenticationHeader,function(a,b){g.debug("Parse header for authentication. "+a.name+" with "+b),e.parseHeader(b)}),a.$on(h.loginSubmitted,function(a,b){c.setLoginRequest(b.username,b.password),k()}),a.$on(h.loginStored,k),g.log()}]);