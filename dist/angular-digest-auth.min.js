/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.3.0 - 2014-01-27
 * @link https://github.com/tafax/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var dgAuth=angular.module("dgAuth",["angular-md5","FSM"]);dgAuth.config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","authService","authClient","authServer","stateMachine",function(a,b,c,d,e,f){return{request:function(a){var e=c.getCredentials(),f=d.processRequest(e.username,e.password,a.method,a.url);return f&&(a.headers.Authorization=f),a||b.when(a)},responseError:function(a){if(401===a.status){if(!e.parseHeader(a))return b.reject(a);var d=b.defer();return c.setRequest(a.config,d),f.send("401",{response:a}),d.promise}return b.reject(a)}}}])}]),dgAuth.config(["stateMachineProvider",function(a){a.config({init:{transitions:{run:"restoringCredentials"}},restoringCredentials:{transitions:{restored:"settingCredentials"},action:["authStorage","params",function(a,b){return a.hasCredentials()&&(b.credentials={username:a.getUsername(),password:a.getPassword()}),b}]},settingCredentials:{transitions:{signin:"loginRequest"},action:["authService","params",function(a,b){if(b.hasOwnProperty("credentials")){var c=b.credentials;a.setCredentials(c.username,c.password)}}]},loginRequest:{transitions:{401:[{to:"waitingCredentials",predicate:["authService","authRequests",function(a,b){return!a.hasCredentials()&&b.getValid()}]},{to:"loginError",predicate:["authService","authRequests",function(a,b){return a.hasCredentials()&&b.getValid()}]},{to:"failureLogin",predicate:["authRequests",function(a){return!a.getValid()}]}],201:"loggedIn"},action:["authRequests",function(a){a.signin()}]},loginError:{transitions:{submitted:"settingCredentials"},action:["authService","params",function(a,b){a.clearCredentials();var c=a.getCallbacks("login.error");for(var d in c){var e=c[d];e(b.response)}}]},waitingCredentials:{transitions:{submitted:"settingCredentials"},action:["authService","authIdentity","name","params",function(a,b,c,d){if("logoutRequest"==c){b.clear(),a.clearRequest();var e=a.getCallbacks("logout.successful");for(var f in e){var g=e[f];g(d.response)}}b.clear(),a.clearCredentials();var h=a.getCallbacks("login.required");for(var i in h){var j=h[i];j(d.response)}}]},loggedIn:{transitions:{signout:"logoutRequest",401:"waitingCredentials"},action:["authService","authIdentity","authStorage","name","params",function(a,b,c,d,e){if("logoutRequest"==d){var f=a.getCallbacks("logout.error");for(var g in f){var h=f[g];h(e.response)}}if("loginRequest"==d){b.set(null,e.response.data),a.clearRequest();var i=a.getCredentials();c.setCredentials(i.username,i.password);var j=a.getCallbacks("login.successful");for(var k in j){var l=j[k];l(e.response)}}}]},logoutRequest:{transitions:{401:"loggedIn",201:"waitingCredentials"},action:["authRequests",function(a){a.signout()}]},failureLogin:{action:["authService","authIdentity","params",function(a,b,c){b.clear(),a.clearCredentials();var d=a.getCallbacks("login.limit");for(var e in d){var f=d[e];f(c.response)}}]}})}]),dgAuth.provider("dgAuthService",function(){function a(a){var b=!1;this.start=function(){a.initialize(),a.send("run"),a.send("restored"),a.send("signin"),b=!0},this.signin=function(){if(!b)throw"You have to start te service first";a.send("signin")},this.signout=function(){if(!b)throw"You have to start te service first";a.send("signout")},this.setCredentials=function(c,d){if(!b)throw"You have to start te service first";a.send("submitted",{credentials:{username:c,password:d}})}}var b=window.sessionStorage;this.setStorage=function(a){b=a},this.getStorage=function(){return b};var c={login:{method:"POST",url:"/signin"},logout:{method:"POST",url:"/signout"}};this.setConfig=function(a){angular.extend(c,a)},this.getConfig=function(){return c};var d=4;this.setLimit=function(a){d=a},this.getLimit=function(){return d},this.callbacks={login:[],logout:[]};var e="";this.setHeader=function(a){e=a},this.getHeader=function(){return e},this.$get=["stateMachine",function(b){return new a(b)}]}),dgAuth.factory("authClient",["$rootScope","authServer","md5",function(a,b,c){function d(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0,e=function(b){for(var c=[],d=a.length,e=0;b>e;++e)c.push(a[Math.random()*d|0]);return c.join("")},f=function(){d++;for(var a=8-d.toString().length,b="",c=0;a>c;c++)b+="0";return b+d},g=function(a,d,e,f,g,h){var i=c.createHash(a+":"+b.info.realm+":"+d),j=c.createHash(e+":"+f);return c.createHash(i+":"+b.info.nonce+":"+g+":"+h+":"+b.info.qop+":"+j)},h=function(a,c,d,h){var i=f(),j=e(16);return'Digest username="'+a+'", realm="'+b.info.realm+'", nonce="'+b.info.nonce+'", uri="'+h+'", algorithm="'+b.info.algorithm+'", response="'+g(a,c,d,h,i,j)+'", opaque="'+b.info.opaque+'", qop="'+b.info.qop+'", nc="'+i+'", cnonce="'+j+'"'};this.isConfigured=function(){return b.isConfigured()},this.processRequest=function(a,c,d,e){var f=null;return this.isConfigured()&&e.indexOf(b.info.domain)>=0&&(f=h(a,c,d,e)),f}}return new d}]),dgAuth.provider("authEvents",function(){function a(a){var b=a;this.getEvents=function(){return b},this.getEvent=function(a){var c=a.split(".");return b[c[0]][c[1]]}}var b={authentication:{headerNotFound:"$authAuthenticationHeaderNotFound",header:"$authAuthenticationHeader",request:"$authAuthenticationRequest"},process:{request:"$authProcessRequest",response:"$authProcessResponse"},login:{successful:"$authSigninSuccessful",error:"$authSigninError",required:"$authSigninRequired"},logout:{successful:"$authSignoutSuccessful",error:"$authSignoutError"},credential:{submitted:"$authCredentialSubmitted",stored:"$authCredentialStored",restored:"$authCredentialRestored"}};this.setEvents=function(a){angular.extend(b,a)},this.$get=function(){return new a(b)}}),dgAuth.factory("authIdentity",["$q","authRequests",function(a,b){function c(){var c=null;this.set=function(a,b){if(a)null==c&&(c={}),c[a]=b;else{if(!(b instanceof Object))throw"You have to provide an object if you want to set the identity without a key.";c=b}},this.get=function(a){return a?c&&c.hasOwnProperty(a)?c[a]:null:c},this.has=function(){return null!==c},this.clear=function(){c=null},this.isAuthorized=function(){var d=a.defer();return b.getPromise().then(function(){d.resolve(null!==c)},function(){d.reject(null!==c)}),d.promise}}return new c}]),dgAuth.provider("authServer",["dgAuthServiceProvider",function(a){function b(a,b){var c=a,d=/([a-zA-Z]+)=\"?([a-zA-Z0-9\/\s]+)\"?/,e=!1;this.info={realm:"",domain:"",nonce:"",opaque:"",algorithm:"",qop:""},this.isConfigured=function(){return e},this.setConfig=function(a){angular.extend(this.info,a),e=!0},this.parseHeader=function(a){var f=a.headers(c);if(e=!1,null!==f){for(var g=f.split(", "),h=0;h<g.length;h++){var i=d.exec(g[h]);this.info[i[1]]=i[2]}b.setServerAuth(this.info),e=!0}return e}}this.$get=["authStorage","authEvents","$rootScope",function(c,d,e){var f=new b(a.getHeader(),c,d,e);return c.hasServerAuth()&&f.setConfig(c.getServerAuth()),f}]}]),dgAuth.provider("authService",["dgAuthServiceProvider",function(a){function b(a,b){var c="",d="";this.setCredentials=function(a,b){c=a.trim(),d=b.trim()},this.getCredentials=function(){return{username:c,password:d}},this.hasCredentials=function(){return""!==c.trim()&&""!==d.trim()},this.clearCredentials=function(){c="",d=""};var e=null;this.setRequest=function(a,b){e={config:a,deferred:b}},this.getRequest=function(){return e},this.hasRequest=function(){return null!==e},this.clearRequest=function(){e=null},this.getCallbacks=function(c){var d=c.split(".");if(d.length>2||0==d.length)throw"The type for the callbacks is invalid.";var e=d[0],f=2==d.length?d[1]:null,g=[];if(a.hasOwnProperty(e)){var h=a[e];for(var i in h){var j=b.invoke(h[i]);f?j.hasOwnProperty(f)&&g.push(j[f]):g.push(j)}}return g}}this.$get=["$injector","stateMachine","authEvents","authStorage","$rootScope","$q",function(c){return new b(a.callbacks,c)}]}]),dgAuth.provider("authRequests",["dgAuthServiceProvider",function(a){function b(a,b,c,d,e){var f=null;this.getPromise=function(){return f};var g=0;this.getValid=function(){return"inf"==a?!0:a>=g};var h=function(){var a=null;if(d.hasRequest()){var b=d.getRequest();a=c(b.config).then(function(a){return b.deferred.resolve(a),a},function(a){return b.deferred.reject(a),a})}return a};this.signin=function(){return g++,(f=h())?f:f=c(b.login).then(function(a){return g=0,e.send("201",{response:a}),a},function(a){return g=0,e.send("failure",{response:a}),a})},this.signout=function(){return(f=h())?f:f=c(b.logout).then(function(a){return e.send("201",{response:a}),a},function(a){return a})}}this.$get=["$http","authService","stateMachine",function(c,d,e){return new b(a.getLimit(),a.getConfig(),c,d,e)}]}]),dgAuth.provider("authStorage",["dgAuthServiceProvider",function(a){function b(a){var b=a,c=window.sessionStorage;this.hasCredentials=function(){var a=b.getItem("username"),c=b.getItem("password");return null!==a&&null!==c&&void 0!==a&&void 0!==c},this.setCredentials=function(a,c){b.setItem("username",a),b.setItem("password",c)},this.hasServerAuth=function(){var a=c.getItem("server");return null!==a&&void 0!==a},this.setServerAuth=function(a){c.setItem("server",angular.toJson(a))},this.getServerAuth=function(){return angular.fromJson(c.getItem("server"))},this.getUsername=function(){return b.getItem("username")},this.getPassword=function(){return b.getItem("password")},this.clear=function(){b.clear(),c.clear()}}this.$get=function(){return new b(a.getStorage())}}]);