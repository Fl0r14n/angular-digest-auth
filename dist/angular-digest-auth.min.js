/**
 * AngularJS module to manage HTTP Digest Authentication
 * @version v0.2.0 - 2014-01-18
 * @link https://github.com/mgonto/angular-digest-auth
 * @author Matteo Tafani Alunno <matteo.tafanialunno@gmail.com>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";var dgAuth=angular.module("dgAuth",["angular-md5","ngCookies"]);dgAuth.config(["$httpProvider",function(a){a.interceptors.push(["$rootScope","$q","authServer","authEvents",function(a,b,c,d){return{request:function(c){return a.$broadcast(d.getEvent("process.request"),c),c||b.when(c)},responseError:function(e){if(401===e.status){if(a.$broadcast(d.getEvent("process.response"),e),e.mustTerminate)return b.reject(e);if(!c.parseHeader(e))return a.$broadcast(d.getEvent("authentication.notFound")),b.reject(e);var f=b.defer(),g={config:e.config,deferred:f};return a.$broadcast(d.getEvent("authentication.header")),a.$broadcast(d.getEvent("authentication.request"),g),a.$broadcast(d.getEvent("login.required")),f.promise}return b.reject(e)}}}])}]),dgAuth.run(["$rootScope","authEvents","authService","authClient",function(a,b,c,d){a.$on(b.getEvent("process.request"),function(a,b){if(d.isConfigured()){var e=c.getCredentials();d.processRequest(e.username,e.password,b)}}),a.$on(b.getEvent("process.response"),function(a,b){c.mustTerminate(b)}),a.$on(b.getEvent("authentication.request"),function(a,b){c.setHttpRequest(b)})}]),dgAuth.factory("authClient",["$rootScope","authServer","md5",function(a,b,c){function d(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0,e=function(b){for(var c=[],d=a.length,e=0;b>e;++e)c.push(a[Math.random()*d|0]);return c.join("")},f=function(){d++;for(var a=8-d.toString().length,b="",c=0;a>c;c++)b+="0";return b+d},g=function(a,d,e,f,g,h){var i=c.createHash(a+":"+b.info.realm+":"+d),j=c.createHash(e+":"+f);return c.createHash(i+":"+b.info.nonce+":"+g+":"+h+":"+b.info.qop+":"+j)},h=function(a,c,d,h){var i=f(),j=e(16);return'Digest username="'+a+'", realm="'+b.info.realm+'", nonce="'+b.info.nonce+'", uri="'+h+'", algorithm='+b.algorithm+', response="'+g(a,c,d,h,i,j)+'", opaque="'+b.info.opaque+'", qop='+b.info.qop+', nc="'+i+'", cnonce="'+j+'"'};this.isConfigured=function(){return b.isConfigured()},this.processRequest=function(a,c,d){d.url.indexOf(b.info.domain)>=0&&(d.headers.Authorization=h(a,c,d.method,d.url))}}return new d}]),dgAuth.provider("authEvents",function(){function a(a){var b=a;this.getEvents=function(){return b},this.getEvent=function(a){var c=a.split(".");return b[c[0]][c[1]]}}var b={authentication:{headerNotFound:"$authAuthenticationHeaderNotFound",header:"$authAuthenticationHeader",request:"$authAuthenticationRequest"},process:{request:"$authProcessRequest",response:"$authProcessResponse"},login:{successful:"$authSigninSuccessful",error:"$authSigninError",required:"$authSigninRequired"},logout:{successful:"$authSignoutSuccessful",error:"$authSignoutError"},credential:{submitted:"$authCredentialSubmitted",stored:"$authCredentialStored",restored:"$authCredentialRestored"}};this.setEvents=function(a){angular.extend(b,a)},this.$get=function(){return new a(b)}}),dgAuth.provider("authServer",function(){function a(a,b){var c=a,d=/([a-zA-Z]+)=\"?([a-zA-Z0-9\/\s]+)\"?/,e=!1;this.info={realm:"",domain:"",nonce:"",opaque:"",algorithm:"",qop:""},this.isConfigured=function(){return e},this.setConfig=function(a){angular.extend(this.info,a),e=!0},this.parseHeader=function(a){var f=a.headers(c);if(null!==f){for(var g=f.split(", "),h=0;h<g.length;h++){var i=d.exec(g[h]);this.info[i[1]]=i[2]}b.setServerAuth(this.info),e=!0}return e}}var b="";this.setHeader=function(a){b=a},this.$get=["authStorage",function(c){var d=new a(b,c);return c.hasServerAuth()&&d.setConfig(c.getServerAuth()),d}]}),dgAuth.provider("authService",[function(){function a(a,b,c,d,e,f,g,h,i){var j=a,k=a.login,l=a.logout,m=a.callbacks,n=a.automatic;this.getConfig=function(){return j};var o=null,p=function(){return{username:"",password:"",httpRequest:null,deferred:null,mustTerminate:!1}},q=function(){return{deferred:null,mustTerminate:!0}},r=p(),s=q();this.setHttpRequest=function(a){angular.extend(r,{httpRequest:a})},this.hasIdentity=function(){return null!==o},this.getIdentity=function(){return o},this.setCredentials=function(a,b){angular.extend(r,{username:a,password:b,mustTerminate:!0}),e.$broadcast(c.getEvent("credential.submitted"),{username:r.username,password:r.password})},this.getCredentials=function(){return{username:r.username,password:r.password}},this.mustTerminate=function(a){return a.config.url==k.url?(a.mustTerminate=r.mustTerminate,void 0):(a.config.url==l.url&&(a.mustTerminate=s.mustTerminate),void 0)};var t=function(){var a=g.defer();return f(k).success(function(b){o=b,h._auth=i.createHash("true"),d.setCredentials(r.username,r.password),e.$broadcast(c.getEvent("credential.stored"),{username:r.username,password:r.password}),e.$broadcast(c.getEvent("login.successful"),b),angular.extend(r,{mustTerminate:!1}),a.resolve(b)}).error(function(b,d){e.$broadcast(c.getEvent("login.error"),b,d),r=p(),a.reject(b)}),a};this.signin=function(){if((h._auth==i.createHash("true")||n)&&d.hasCredential()&&(angular.extend(r,{username:d.getUsername(),password:d.getPassword(),mustTerminate:!0}),e.$broadcast(c.getEvent("credential.restored"),{username:r.username,password:r.password})),r.httpRequest){var a=f(r.httpRequest.config).then(function(a){r.httpRequest.deferred.resolve(a)},function(a){r.httpRequest.deferred.reject(a)});a["finally"](function(){r.httpRequest=null})}else if(!r.deferred){r.deferred=t();for(var g in m.login){var j=b.invoke(m.login[g]);r.deferred.promise.then(j.successful,j.error)}}return r.deferred.promise};var u=function(){var a=g.defer();return f(l).success(function(b){h._auth=i.createHash("false"),o=null,r=p(),e.$broadcast(c.getEvent("logout.successful"),b),a.resolve(b)}).error(function(b,d){e.$broadcast(c.getEvent("logout.error"),b,d),a.reject(b)}),a};this.signout=function(){if(!s.deferred){s.deferred=u();for(var a in m.logout){var c=b.invoke(m.logout[a]);s.deferred.promise.then(c.successful,c.error)}}return s.deferred.promise},this.isAuthenticated=function(){var a=g.defer();return s.deferred?s.deferred.promise.then(function(){a.reject(null)},function(){a.resolve(h._auth==i.createHash("true")&&null!==o)}):r.deferred&&r.deferred.promise.then(function(){a.resolve(h._auth==i.createHash("true")&&null!==o)},function(b){a.reject(b)}),a.promise}}this.callbacks={login:[],logout:[]};var b=!1;this.setAutomatic=function(a){b=a},this.getAutomatic=function(){return b};var c={login:{method:"POST",url:"/signin"},logout:{method:"POST",url:"/signout"}};this.setConfig=function(a){angular.extend(c,a)},this.$get=["$injector","authEvents","authStorage","$rootScope","$http","$q","$cookies","md5",function(d,e,f,g,h,i,j,k){return new a({login:c.login,logout:c.logout,callbacks:this.callbacks,automatic:b},d,e,f,g,h,i,j,k)}]}]),dgAuth.provider("authStorage",function(){function a(a){var b=a;this.hasCredential=function(){var a=b.getItem("username"),c=b.getItem("password");return null!==a&&null!==c},this.setCredentials=function(a,c){b.setItem("username",a),b.setItem("password",c)},this.hasServerAuth=function(){return null!==sessionStorage.getItem("server")},this.setServerAuth=function(a){sessionStorage.setItem("server",JSON.stringify(a))},this.getServerAuth=function(){return JSON.parse(sessionStorage.getItem("server"))},this.getUsername=function(){return b.getItem("username")},this.getPassword=function(){return b.getItem("password")},this.clear=function(){b.clear(),sessionStorage.clear()}}var b=sessionStorage;this.setStorage=function(a){b=a},this.$get=function(){return new a(b)}});